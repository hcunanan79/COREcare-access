{% extends "base.html" %}

{% block title %}{% if is_edit %}Edit{% else %}Add{% endif %} Event - {{ client.first_name }}{% endblock %}

{% block content %}
<div class="main-content">

    <!-- Breadcrumb -->
    <a href="{% url 'client_calendar' client_id=client.id %}" class="back-link">
        &larr; Back to Calendar
    </a>

    <div class="client-header">
        <div>
            <h1>{% if is_edit %}Edit Event{% else %}Add New Event{% endif %}</h1>
            <p class="client-header-subtitle">{{ client.first_name }} {{ client.last_name }}</p>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="message-container" style="margin-bottom: 1rem;">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Event Form -->
    <div class="card event-form-card">
        <form method="post" class="event-form">
            {% csrf_token %}

            <!-- Essential Fields (Always Visible) -->
            <div class="form-section">
                <h3 class="form-section-title">Event Details</h3>

                <div class="form-group">
                    <label for="title" class="form-label required">Event Title</label>
                    <input type="text" id="title" name="title" class="form-input"
                        placeholder="e.g., Doctor Appointment, Physical Therapy"
                        value="{% if form_data %}{{ form_data.title }}{% elif event %}{{ event.title }}{% endif %}"
                        required maxlength="200">
                </div>

                <div class="form-group">
                    <label for="event_type" class="form-label required">Event Type</label>
                    <select id="event_type" name="event_type" class="form-input">
                        {% for value, label in event_types %}
                        <option value="{{ value }}" {% if form_data.event_type==value or event.event_type==value
                            %}selected{% endif %}>
                            {% if value == 'medical' %}ü©∫{% elif value == 'social' %}üë•{% elif value == 'family'
                            %}üë®‚Äçüë©‚Äçüëß{% elif value == 'therapy' %}üíÜ{% elif value == 'transportation' %}üöó{% else
                            %}üìå{% endif %}
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="start_date" class="form-label required">Start Date</label>
                        <input type="date" id="start_date" name="start_date" class="form-input"
                            value="{% if form_data %}{{ form_data.start_date }}{% elif event %}{{ event.start_time|date:'Y-m-d' }}{% else %}{{ default_date }}{% endif %}"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="start_time" class="form-label required">Start Time</label>
                        <input type="time" id="start_time" name="start_time" class="form-input"
                            value="{% if form_data %}{{ form_data.start_time }}{% elif event %}{{ event.start_time|date:'H:i' }}{% else %}09:00{% endif %}"
                            required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="end_date" class="form-label required">End Date</label>
                        <input type="date" id="end_date" name="end_date" class="form-input"
                            value="{% if form_data %}{{ form_data.end_date }}{% elif event %}{{ event.end_time|date:'Y-m-d' }}{% else %}{{ default_date }}{% endif %}"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="end_time" class="form-label required">End Time</label>
                        <input type="time" id="end_time" name="end_time" class="form-input"
                            value="{% if form_data %}{{ form_data.end_time }}{% elif event %}{{ event.end_time|date:'H:i' }}{% else %}10:00{% endif %}"
                            required>
                    </div>
                </div>
            </div>

            <!-- Optional Fields (Progressive Disclosure) -->
            <details class="form-section-details">
                <summary class="form-section-toggle">
                    <i class="fas fa-chevron-right"></i> More Options
                </summary>

                <div class="form-section">
                    <div class="form-group">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" id="location" name="location" class="form-input"
                            placeholder="e.g., Dr. Smith's Office, 123 Main St"
                            value="{% if form_data %}{{ form_data.location }}{% elif event %}{{ event.location }}{% endif %}"
                            maxlength="255">
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">Notes / Instructions</label>
                        <textarea id="description" name="description" class="form-input form-textarea" rows="4"
                            placeholder="Any additional details caregivers should know...">{% if form_data %}{{ form_data.description }}{% elif event %}{{ event.description }}{% endif %}</textarea>
                    </div>
                </div>
            </details>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{% url 'client_calendar' client_id=client.id %}" class="btn btn-secondary">
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    {% if is_edit %}Update Event{% else %}Create Event{% endif %}
                </button>
            </div>
        </form>
    </div>

</div>

<style>
    .event-form-card {
        max-width: 600px;
    }

    .form-section {
        margin-bottom: 1.5rem;
    }

    .form-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary, #1f2937);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color, #e5e7eb);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary, #6b7280);
        margin-bottom: 0.375rem;
    }

    .form-label.required::after {
        content: " *";
        color: #ef4444;
    }

    .form-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color, #3b82f6);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-section-details {
        margin-bottom: 1.5rem;
    }

    .form-section-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: var(--bg-secondary, #f9fafb);
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-secondary, #6b7280);
        transition: background 0.15s ease;
    }

    .form-section-toggle:hover {
        background: var(--bg-tertiary, #f3f4f6);
    }

    .form-section-details[open] .form-section-toggle {
        margin-bottom: 1rem;
    }

    .form-section-details[open] .form-section-toggle i {
        transform: rotate(90deg);
    }

    .form-section-toggle i {
        transition: transform 0.15s ease;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color, #e5e7eb);
    }

    .alert {
        padding: 0.75rem 1rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .alert-error {
        background: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column-reverse;
        }

        .form-actions .btn {
            width: 100%;
        }
    }
</style>

<script>
    // Auto-sync end date with start date when start date changes
    document.getElementById('start_date').addEventListener('change', function () {
        const endDateInput = document.getElementById('end_date');
        if (!endDateInput.value || endDateInput.value < this.value) {
            endDateInput.value = this.value;
        }
    });
</script>
{% endblock %}